<!--
GS
12 Mar. 2023
My answer with this content: https://stackoverflow.com/a/75718815/4561887
-->

Looking at the excellent answers [from @ManuelSchneid3r here](https://stackoverflow.com/a/13513907/4561887) and [@amritkrs here](https://stackoverflow.com/a/41954177/4561887), I have finally been able to put together (over more than 1 year of effort now) a more up-to-date set of instructions, as well as additional insight and information not provided by any other answer here, and which I have been trying to figure out for 5 years. 

This includes a lot about gcc/g++ libraries, installing libraries, naming .a statically-linked library files, where g++ searches for includes, etc.

## How to install Google Test (`gtest`) and Google Mock (`gmock`) as shared, static `.a` libraries, system-wide, on Linux/Unix

_Tested on Ubuntu 20.04 with the latest (unreleased, `git pull`ed) version of [googletest](https://github.com/google/googletest) (more recent than v1.13.0)._

**If in a hurry, just run the several commands in the install section, then look at the "Example usage" shortly after.**

Note: googletest has undergone a variety of changes over the last few years. For example, gtest and gmock are now packaged under the same repo, here: https://github.com/google/googletest. So, following my instructions will install _both_ for you.


#### 1. Install the latest gtest and gmock from source

If you want the latest _released_ version, find it here: https://github.com/google/googletest/releases. 

You can download it with `wget` like this, for instance:
```bash
# Download release v1.13.0
wget https://github.com/google/googletest/archive/refs/tags/v1.13.0.tar.gz
```

I prefer to just get the most-up-to-date content from the repo itself, however. Here are my full instructions, doing that:

```bash
sudo apt update
sudo apt install cmake

# You can find some of these instructions, here: 
# https://github.com/google/googletest/tree/main/googletest
time git clone https://github.com/google/googletest.git
cd googletest        # "Main directory of the cloned repository."
mkdir build          # "Create a directory to hold the build output."
cd build
time cmake ..        # "Generate native make build scripts for GoogleTest."
                        # Takes ~2 seconds.
time make            # Run those makefiles just autogenerated by cmake above.
                        # Takes ~10 seconds.
sudo make install    # Install the .a library files, and headers, into 
                        # /user/local/.
```

Done! 

You can now include the necessary headers into your files as shown above. 

Note: here is the full output of what was copied over, or "installed", into `/usr/local` when you ran `sudo make install`:

```bash
googletest/build$ sudo make install
[ 25%] Built target gtest
[ 50%] Built target gmock
[ 75%] Built target gmock_main
[100%] Built target gtest_main
Install the project...
-- Install configuration: ""
-- Up-to-date: /usr/local/include
-- Installing: /usr/local/include/gmock
-- Installing: /usr/local/include/gmock/gmock.h
-- Installing: /usr/local/include/gmock/gmock-actions.h
-- Installing: /usr/local/include/gmock/gmock-more-matchers.h
-- Installing: /usr/local/include/gmock/gmock-spec-builders.h
-- Installing: /usr/local/include/gmock/gmock-function-mocker.h
-- Installing: /usr/local/include/gmock/internal
-- Installing: /usr/local/include/gmock/internal/gmock-pp.h
-- Installing: /usr/local/include/gmock/internal/gmock-internal-utils.h
-- Installing: /usr/local/include/gmock/internal/gmock-port.h
-- Installing: /usr/local/include/gmock/internal/custom
-- Installing: /usr/local/include/gmock/internal/custom/gmock-port.h
-- Installing: /usr/local/include/gmock/internal/custom/gmock-matchers.h
-- Installing: /usr/local/include/gmock/internal/custom/gmock-generated-actions.h
-- Installing: /usr/local/include/gmock/internal/custom/README.md
-- Installing: /usr/local/include/gmock/gmock-cardinalities.h
-- Installing: /usr/local/include/gmock/gmock-more-actions.h
-- Installing: /usr/local/include/gmock/gmock-matchers.h
-- Installing: /usr/local/include/gmock/gmock-nice-strict.h
-- Installing: /usr/local/lib/libgmock.a
-- Installing: /usr/local/lib/libgmock_main.a
-- Installing: /usr/local/lib/pkgconfig/gmock.pc
-- Installing: /usr/local/lib/pkgconfig/gmock_main.pc
-- Installing: /usr/local/lib/cmake/GTest/GTestTargets.cmake
-- Installing: /usr/local/lib/cmake/GTest/GTestTargets-noconfig.cmake
-- Installing: /usr/local/lib/cmake/GTest/GTestConfigVersion.cmake
-- Installing: /usr/local/lib/cmake/GTest/GTestConfig.cmake
-- Up-to-date: /usr/local/include
-- Installing: /usr/local/include/gtest
-- Installing: /usr/local/include/gtest/gtest-param-test.h
-- Installing: /usr/local/include/gtest/gtest-printers.h
-- Installing: /usr/local/include/gtest/gtest-test-part.h
-- Installing: /usr/local/include/gtest/internal
-- Installing: /usr/local/include/gtest/internal/gtest-port.h
-- Installing: /usr/local/include/gtest/internal/gtest-death-test-internal.h
-- Installing: /usr/local/include/gtest/internal/gtest-filepath.h
-- Installing: /usr/local/include/gtest/internal/custom
-- Installing: /usr/local/include/gtest/internal/custom/gtest-printers.h
-- Installing: /usr/local/include/gtest/internal/custom/gtest-port.h
-- Installing: /usr/local/include/gtest/internal/custom/gtest.h
-- Installing: /usr/local/include/gtest/internal/custom/README.md
-- Installing: /usr/local/include/gtest/internal/gtest-string.h
-- Installing: /usr/local/include/gtest/internal/gtest-type-util.h
-- Installing: /usr/local/include/gtest/internal/gtest-param-util.h
-- Installing: /usr/local/include/gtest/internal/gtest-port-arch.h
-- Installing: /usr/local/include/gtest/internal/gtest-internal.h
-- Installing: /usr/local/include/gtest/gtest_pred_impl.h
-- Installing: /usr/local/include/gtest/gtest-assertion-result.h
-- Installing: /usr/local/include/gtest/gtest-typed-test.h
-- Installing: /usr/local/include/gtest/gtest-spi.h
-- Installing: /usr/local/include/gtest/gtest_prod.h
-- Installing: /usr/local/include/gtest/gtest.h
-- Installing: /usr/local/include/gtest/gtest-message.h
-- Installing: /usr/local/include/gtest/gtest-death-test.h
-- Installing: /usr/local/include/gtest/gtest-matchers.h
-- Installing: /usr/local/lib/libgtest.a
-- Installing: /usr/local/lib/libgtest_main.a
-- Installing: /usr/local/lib/pkgconfig/gtest.pc
-- Installing: /usr/local/lib/pkgconfig/gtest_main.pc
```


#### 2. Background: the above installation instructions have just:

1. Installed gtest and gmock `*.a` static library files into `/usr/local/lib` so that you can build and run your gtest and gmock programs using these simple `g++` build flags (used by the linker, `ld`):

    1. `-lgtest`
        Link against the `/usr/local/lib/libgtest.a` static library file, which provides general googletest functionality.
    1. `-lgtest_main`
        Link against the `/usr/local/lib/libgtest_main.a` static library file, which provides a default `main()` function needed by googletest.
    1. `-lgmock`
        Link against the `/usr/local/lib/libgmock.a` static library file, which provides general googlemock functionality.
    1. `-lgmock_main`
        Link against the `/usr/local/lib/libgmock_main.a` static library file, which provides a default `main()` function needed by googlemock.
    1. `-pthread` 
        Required by googletest, since it uses POSIX threads under the hood.

    _Notes:_
    1. Order matters. Ensure your flags above come *after* the files which need them. 
    1. If you were to set the necessary CMake define to build shared dynamically-linked .so libraries instead of the static .a libraries we are building, then the `-l` flags above would cause the run-time linker to link against those instead, at run-time. See [@amritkrs's answer](https://stackoverflow.com/a/41954177/4561887) for more info. on that. Following my instructions, however, will cause those same `-l` flags to link at build-time instead, placing the entire pre-built .a static library file binaries into your executables. 

1. Installed all gtest and gmock header files that you need to include in your programs into `/usr/local/include/gtest` and `/usr/local/include/gmock`, respectively. 

    This allows you to includes the necessary files in your programs, like this:

    ```cpp
    // Include in your unit tests
    #include <gtest/gtest.h>
    #include <gmock/gmock.h>

    // Include in your production code to give gtest access to private members
    // in your classes, as friends, via the 
    // `FRIEND_TEST(TestSuiteName, TestName);` macro, for instance.
    #include <gtest/gtest_prod.h>
    ```


#### 3. Example usage: 

```bash
# Build and run an example googletest unit test that comes in the repo:
# - required in this case: `-pthread`, `-lgtest`, and `-lgtest_main`

mkdir -p bin

time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread \
    googletest/googletest/samples/sample1_unittest.cc \
    googletest/googletest/samples/sample1.cc \
    -lgtest -lgtest_main -o bin/a && time bin/a
```


#### 4. Run an example unit test

Manually test-build and run a sample test included in the repo:
```bash
# (run while still in the googletest/build dir)
time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread \
    ../googletest/samples/sample1_unittest.cc \
    ../googletest/samples/sample1.cc \
    -lgtest -lgtest_main -o bin/a && time bin/a
```

Sample run and output:
```bash
googletest/build$ time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread \
>     ../googletest/samples/sample1_unittest.cc \
>     ../googletest/samples/sample1.cc \
>     -lgtest -lgtest_main -o bin/a && time bin/a

real    0m1.879s
user    0m1.740s
sys 0m0.135s
Running main() from /home/gabriel/GS/dev/temp/googletest/googletest/src/gtest_main.cc
[==========] Running 6 tests from 2 test suites.
[----------] Global test environment set-up.
[----------] 3 tests from FactorialTest
[ RUN      ] FactorialTest.Negative
[       OK ] FactorialTest.Negative (0 ms)
[ RUN      ] FactorialTest.Zero
[       OK ] FactorialTest.Zero (0 ms)
[ RUN      ] FactorialTest.Positive
[       OK ] FactorialTest.Positive (0 ms)
[----------] 3 tests from FactorialTest (0 ms total)

[----------] 3 tests from IsPrimeTest
[ RUN      ] IsPrimeTest.Negative
[       OK ] IsPrimeTest.Negative (0 ms)
[ RUN      ] IsPrimeTest.Trivial
[       OK ] IsPrimeTest.Trivial (0 ms)
[ RUN      ] IsPrimeTest.Positive
[       OK ] IsPrimeTest.Positive (0 ms)
[----------] 3 tests from IsPrimeTest (0 ms total)

[----------] Global test environment tear-down
[==========] 6 tests from 2 test suites ran. (0 ms total)
[  PASSED  ] 6 tests.

real    0m0.003s
user    0m0.000s
sys 0m0.002s
```


#### 5. Uninstall

To remove/uninstall gtest and gmock, just manually remove all of the files that were copied over by `sudo make install`. Hare are the commands to do that:

```bash
# remove the main libraries
sudo rm /usr/local/lib/libgtest.a \
        /usr/local/lib/libgtest_main.a \
        /usr/local/lib/libgmock.a \
        /usr/local/lib/libgmock_main.a

# remove the include dirs
sudo rm -r /usr/local/include/gtest \
           /usr/local/include/gmock

# extras

# remove the package config (whatever that is)
sudo rm /usr/local/lib/pkgconfig/gtest.pc \
        /usr/local/lib/pkgconfig/gtest_main.pc \
        /usr/local/lib/pkgconfig/gmock.pc \
        /usr/local/lib/pkgconfig/gmock_main.pc

# remove cmake GTest stuff
sudo rm -r /usr/local/lib/cmake/GTest
```


## Going further: general information about libraries; debugging; gcc/g++ compiler flags; etc.

1. When compiling, `g++` searches your include directories for all header files your code includes. The default C++ system-wide include paths can be found by running `$(gcc -print-prog-name=cc1plus) -v` and then pressing Ctrl + C after a second to kill it (see here: [Where does gcc look for C and C++ header files?](https://stackoverflow.com/a/344525/4561887)). They include primarily:
    ```bash
    /usr/include        # system-added includes
    /usr/local/include  # user-added includes

    # as well as some more include paths to pull in compiler includes
    ```

    Include directories also include any that you have passed to `g++` via `-I` flags, such as `-I"path/to/some/personal/include_dir1" -I"path/to/include_dir2"`, etc.  

    Storing gtest's includes in `/usr/local/include` directly means that you never have to pass custom `-I` flags to specify where they will be. The compiler just always has them available now!

1. Similar to the above "include" concept, library files, such as statically-linked .a files (or dynamically-linked .so files) can be linked to your executable by passing them as inputs to `g++`. 

    Example: this command, from [my answer here](https://stackoverflow.com/a/72108315/4561887), manually specifies the `gtest` and `gmock` include directories, as well as the pre-built .a files, and builds the `googletest/googletest/samples/sample1_unittest.cc` example program:
    ```bash
    # Note: the specified .a files here must actually be locally stored in
    # a local "bin" path, as specified in this command
    time ( \
        time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread \
        -I"googletest/googletest/include" -I"googletest/googlemock/include" \
        googletest/googletest/samples/sample1_unittest.cc \
        googletest/googletest/samples/sample1.cc \
        bin/libgtest.a bin/libgtest_main.a \
        -o bin/a \
        && time bin/a \
    )
    ```

    Or, by copying the includes to `/usr/local/include` and the .a static library files to `/usr/local/lib`, you can simplify that command greatly and run this instead! The include directories no longer need to be specified at all, and instead of passing `path/to/libgtest.a` and `path/to/libgtest_main.a`, you simply pass `-lgtest` and `-lgtest_main`, respectively, instead:
    ```bash
    time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread \
        googletest/googletest/samples/sample1_unittest.cc \
        googletest/googletest/samples/sample1.cc \
        -lgtest -lgtest_main -o bin/a && time bin/a
    ```

1. Instead of running `sudo make install` to install the gtest and gmock headers and libraries into `/usr/local/include` and `/usr/local/lib`, respectively, you can **manually install the header files and libraries** by copying them like this if you want:
    ```bash
    # manually install the .a libraries, and header files

    # give access to g++ flags `-lgtest`, `-lgtest_main`, `-lgmock`, and
    # `-lgmock_main`, by copying over the .a static library files
    sudo cp -i -t /usr/local/lib \
        lib/libgtest.a lib/libgtest_main.a lib/libgmock.a lib/libgmock_main.a
    # give access to include header files `<gtest/gmock.h>` `<gtest/gtest.h>`, 
    # `<gtest/gtest_prod.h>`, etc.
    # 1. gtest header file includes
    sudo cp -a path/to/googletest/googletest/include/gtest /usr/local/include
    # 2. gmock header file includes
    sudo cp -a path/to/googletest/googlemock/include/gmock /usr/local/include 
    ```

    I first learned that concept [in @ManuelSchneid3r's answer here](https://stackoverflow.com/a/13513907/4561887). I tested it myself. 

1. Without header files installed or a `-I` path specified to them, you'll see failures to include your desired headers, such as `fatal error: gtest/gtest.h: No such file or directory` here:
    ```bash
    eRCaGuy_hello_world/cpp$ time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread  googletest/googletest/samples/sample1_unittest.cc     googletest/googletest/samples/sample1.cc     -lgtest -lgtest_main     -o bin/a      && time bin/a
    googletest/googletest/samples/sample1_unittest.cc:46:10: fatal error: gtest/gtest.h: No such file or directory
       46 | #include "gtest/gtest.h"
          |          ^~~~~~~~~~~~~~~
    compilation terminated.

    real    0m0.046s
    user    0m0.039s
    sys 0m0.007s
    ```

1. Without libraries (.a or .so files) installed, and if you try to use `-lgtest` for example instead of passing `path/to/libgtest.a` directly, you'll see failures to link via the `ld` linker, such as `cannot find -lgtest` here:
    ```bash
    eRCaGuy_hello_world/cpp$ time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread  googletest/googletest/samples/sample1_unittest.cc     googletest/googletest/samples/sample1.cc     -lgtest -lgtest_main     -o bin/a      && time bin/a
    /usr/bin/ld: cannot find -lgtest
    /usr/bin/ld: cannot find -lgtest_main
    collect2: error: ld returned 1 exit status

    real    0m1.895s
    user    0m1.776s
    sys 0m0.119s
    ```
1. If you copy your library files to a known `g++` system-wide library path, such as `/usr/local/lib` (recommended for user-installed .a and .so libraries) or `/usr/lib` (for system-installed .a and .so libraries), the .a files **must** be named `libwhatever.a`, for instance, in order to be used as `-lwhatever`. 

    You cannot call them `lwhatever.a`, or `libwhatever`. They _must_ be named `libwhatever.a`. 

    So, **having file `/usr/local/lib/libgtest.a` enables the `-lgtest` library linker flag**, but `/usr/local/lib/lgtest.a` does not. 

    If your name is wrong and then try to use the `-lgtest` flag, you'll see the `/usr/bin/ld: cannot find -lgtest` linker error as previously shown above, since this library is not properly named and "installed".

    Again, this means if you call it `/usr/local/lib/libwhatever.a`, then you must use `-lwhatever` as the linker flag to that library.

    Note that per `ld --help`, the `-l` (lowercase "L") flags are apparently passed to the `ld` linker, and presumably the `l` stands for `l`ibrary. See my question here: [Meaning of `-l` (lowercase "L") flags in gcc/g++](https://stackoverflow.com/q/75710217/4561887). From `ld --help`:

    >     -l LIBNAME, --library LIBNAME  
    >                                 Search for library LIBNAME

1. Looking at library files inside `/usr/local/lib` and `/usr/lib`, the linker naming convention for libraries, whether static .a or dynamic .so files, seems to **require** that the library file name *must* be prefixed with `lib`!

1. Gtest uses POSIX threads (pthreads) under the hood, so you must always pass the `-pthread` flag to `g++` too.

1. A [google search for `g++ "-lpthread" vs "-pthread"`](https://www.google.com/search?q=g%2B%2B+%22-lpthread%22+vs+%22-pthread%22&oq=g%2B%2B+%22-lpthread%22+vs+%22-pthread%22&aqs=chrome..69i57.191j0j9&sourceid=chrome&ie=UTF-8) reveals this answer: [Difference between `-pthread` and `-lpthread` while compiling](https://stackoverflow.com/a/23251828/4561887), which says that the difference between `-lpthread` and `-pthread` is historical, so on today's gcc/g++ and clang compilers, **you should always just use `-pthread` to bring in POSIX threads.** 

    The `-lpthread` library is now an empty binary apparently and doesn't do anything except satisfy ancient requirements where that library must still be included in some places. But, `-pthread` handles that all for you, so just use `-pthread` alone and be done!

_That about covers it. I now know more about g++, libraries, and gtest._


## References:
1. [Answer by @ManuelSchneid3r](https://stackoverflow.com/a/13513907/4561887)
1. [Answer by @amritkrs](https://stackoverflow.com/a/41954177/4561887)
1. https://github.com/google/googletest
    1. https://github.com/google/googletest/tree/main/googletest
1. My Q&A: [How do I build and use googletest (gtest) and googlemock (gmock) with gcc/g++ or clang?](https://stackoverflow.com/q/72108314/4561887)
1. MY Q: [Meaning of `-l` (lowercase "L") flags in gcc/g++](https://stackoverflow.com/q/75710217/4561887)
