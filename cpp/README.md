This file is part of eRCaGuy_hello_world: https://github.com/ElectricRCAircraftGuy/eRCaGuy_hello_world


# Googletest setup: how to build googletest (gtest and gmock) with the gcc/g++ compiler


## References: 
1. https://github.com/google/googletest
    1. https://github.com/google/googletest/tree/main/googletest
1. \*\*\*\*\*+ https://ethz-adrl.github.io/ct/ct_core/doc/html/md__home_adrl_code_src_control-toolbox_ct_core_build_test_googletest-src_googletest_README.html - this is the main source for all of the examples below because it is the _only_ source I could find which showed me how to use g++ to build googletest from scratch. It is where I learned how to build `gtest` and the associated static library files (including the `libgtest.a` and `libgtest_main.a` static library .a archive files, for instance) with g++. 


## First, clone the googletest source code and symlink it into your repo

_These steps are required before any of the build options below will work._

```bash
# cd into your repo of interest (for me: `eRCaGuy_hello_world`)
cd path/to/eRCaGuy_hello_world
# go up one level to be at the same level as `eRCaGuy_hello_world`
cd ..

# clone the googletest repo
git clone https://github.com/google/googletest.git
# you now have the folder "googletest" at the same level as "eRCaGuy_hello_world"; ex:
#   some/dir/eRCaGuy_hello_world
#   some/dir/googletest

# cd into the folder where you want the symlink to googletest be located
cd eRCaGuy_hello_world/cpp
# create a relative symlink to googletest here
ln -si ../../googletest .
# You now have the symlink dir "eRCaGuy_hello_world/cpp/googletest", which contains the full 
# "googletest" repo source code
```


## Build all of gtest and gmock as static library archive `*.a` files

See: https://ethz-adrl.github.io/ct/ct_core/doc/html/md__home_adrl_code_src_control-toolbox_ct_core_build_test_googletest-src_googletest_README.html

Note: to build *all* of the `gtest` and `gmock` library files, all you need to build are the following. The next steps show how to do that.
```bash
# Files to build for gtest and gmock

# gtest
googletest/googletest/src/gtest-all.cc
googletest/googletest/src/gtest_main.cc
# gmock
googletest/googlemock/src/gmock-all.cc
googletest/googlemock/src/gmock_main.cc
```

### Option 1 [recommended/my preference]: _manually_ build the `*.a` static library files with g++:

Be sure to build (just below) the object files with the same exact build options you plan to use for your unit tests. If you use different build options for your unit tests, you may also need to rebuild gtest and gmock.

```bash
cd path/to/eRCaGuy_hello_world/cpp

# [takes ~15 sec] build the 4 gtest and gmock *.o object files; note that `-c` means: "Compile or
# assemble the source files, but do not link."; optionally add `--verbose` for verbose output
time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread -c \
    -I"googletest/googletest/include" -I"googletest/googletest" \
    -I"googletest/googlemock/include" -I"googletest/googlemock" \
    googletest/googletest/src/gtest-all.cc googletest/googletest/src/gtest_main.cc \
    googletest/googlemock/src/gmock-all.cc googletest/googlemock/src/gmock_main.cc

# move all of the object files just created to the "bin" dir
mv -t bin gtest-all.o gtest_main.o gmock-all.o gmock_main.o

# Use the `ar` "archive" utility to create the *.a static library archive files from the 4 object
# files above
time ar -rv bin/libgtest.a bin/gtest-all.o
time ar -rv bin/libgtest_main.a bin/gtest_main.o
time ar -rv bin/libgmock.a bin/gmock-all.o
time ar -rv bin/libgmock_main.a bin/gmock_main.o
```

You now have:
```bash
bin/libgtest.a
bin/libgtest_main.a
bin/libgmock.a
bin/libgmock_main.a
```

### Option 2: build with the Cmake files which come with the source code

Source: https://github.com/google/googletest/tree/main/googletest#generic-build-instructions 

```bash
git clone https://github.com/google/googletest.git
cd googletest        # Main directory of the cloned repository.
mkdir build          # Create a directory to hold the build output.
cd build
time cmake ..        # Generate native make build scripts for GoogleTest.

time make            # Run those makefiles just autogenerated by cmake above.
```

You'll now have the following 4 library files built with whatever build settings were pre-specified for you in the cmake files:

```bash
googletest/build/lib/libgmock.a
googletest/build/lib/libgmock_main.a
googletest/build/lib/libgtest.a
googletest/build/lib/libgtest_main.a
```

To more-fully control the build settings, I therefore recommend you just use the _manual_ g++ build steps above, instead.

**Sample output from the steps above:**

1. Sample output from `time cmake`:
    ```bash
    eRCaGuy_hello_world/cpp/googletest/build$ time cmake ..
    -- The C compiler identification is GNU 8.4.0
    -- The CXX compiler identification is GNU 8.4.0
    -- Check for working C compiler: /usr/bin/cc
    -- Check for working C compiler: /usr/bin/cc -- works
    -- Detecting C compiler ABI info
    -- Detecting C compiler ABI info - done
    -- Detecting C compile features
    -- Detecting C compile features - done
    -- Check for working CXX compiler: /usr/bin/c++
    -- Check for working CXX compiler: /usr/bin/c++ -- works
    -- Detecting CXX compiler ABI info
    -- Detecting CXX compiler ABI info - done
    -- Detecting CXX compile features
    -- Detecting CXX compile features - done
    -- Found PythonInterp: /usr/bin/python (found version "2.7.17") 
    -- Looking for pthread.h
    -- Looking for pthread.h - found
    -- Looking for pthread_create
    -- Looking for pthread_create - not found
    -- Looking for pthread_create in pthreads
    -- Looking for pthread_create in pthreads - not found
    -- Looking for pthread_create in pthread
    -- Looking for pthread_create in pthread - found
    -- Found Threads: TRUE  
    -- Configuring done
    -- Generating done
    -- Build files have been written to: /home/gabriel/GS/dev/eRCaGuy_hello_world/cpp/googletest/build

    real    0m1.202s
    user    0m0.879s
    sys 0m0.245s
    ```
1. Sample output from `time make`:
    ```bash
    eRCaGuy_hello_world/cpp/googletest/build$ time make
    Scanning dependencies of target gtest
    [ 12%] Building CXX object googletest/CMakeFiles/gtest.dir/src/gtest-all.cc.o
    [ 25%] Linking CXX static library ../lib/libgtest.a
    [ 25%] Built target gtest
    Scanning dependencies of target gmock
    [ 37%] Building CXX object googlemock/CMakeFiles/gmock.dir/src/gmock-all.cc.o
    [ 50%] Linking CXX static library ../lib/libgmock.a
    [ 50%] Built target gmock
    Scanning dependencies of target gmock_main
    [ 62%] Building CXX object googlemock/CMakeFiles/gmock_main.dir/src/gmock_main.cc.o
    [ 75%] Linking CXX static library ../lib/libgmock_main.a
    [ 75%] Built target gmock_main
    Scanning dependencies of target gtest_main
    [ 87%] Building CXX object googletest/CMakeFiles/gtest_main.dir/src/gtest_main.cc.o
    [100%] Linking CXX static library ../lib/libgtest_main.a
    [100%] Built target gtest_main

    real    0m5.482s
    user    0m5.125s
    sys 0m0.346s
    ```


## Build your unit tests using gtest and/or gmock

### Option 1 [my preference/recommended!] build your unit test using the pre-built `*.a` static library files from above:

This is the easiest technique in my opinion, and it also builds the _fastest_ since it is using prebuilt static library `*.a` files rather than rebuilding gtest and gmock from scratch.

I learned this technique here: https://ethz-adrl.github.io/ct/ct_core/doc/html/md__home_adrl_code_src_control-toolbox_ct_core_build_test_googletest-src_googletest_README.html

```bash
cd path/to/eRCaGuy_hello_world/cpp

# [takes ~2 sec] build & run your unit tests
# Optionally add `--verbose` for verbose output.
#
# Notes:
# 1. Include whatever libraries you want; add "bin/libgmock.a" too, if gmock is needed.
# 1. Remove "bin/libgtest_main.a" if you'd like to write your own `main()` function!
# 1. NB: If you use different build options here than you used to build the *.a static libraries 
#    above, you may need to rebuild the *.a files above with those new options.
time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread \
    -I"googletest/googletest/include" -I"googletest/googlemock/include" \
    gtest_demo__sample1_factorial_and_is_prime_unittest.cc \
    gtest_demo__sample1_factorial_and_is_prime.cc \
    bin/libgtest.a bin/libgtest_main.a \
    -o bin/a && time bin/a
```

I like to wrap it up in an outer `time` call too, however, to time the duration of the entire thing. See my answer here: 

```bash
# MY FAVORITE COMMAND/TECHNIQUE <===========
time ( \
    time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread \
    -I"googletest/googletest/include" -I"googletest/googlemock/include" \
    gtest_demo__sample1_factorial_and_is_prime_unittest.cc \
    gtest_demo__sample1_factorial_and_is_prime.cc \
    bin/libgtest.a bin/libgtest_main.a \
    -o bin/a \
    && time bin/a \
)
```

### Option 2: rebuild your unit test _and_ the entire gtest/gmock library all at once

Use this option if you really want to be sure you build gtest/gmock with the _exact same build options_ as your unit test files! This technique is slower, however, because it rebuilds the entire gtest/gmock library every time you build your unit test files.

```bash
cd path/to/eRCaGuy_hello_world/cpp

# [takes ~11 sec (since it's only building gtest, not gmock)] build & run gtest & your unit 
# tests all at once
# Optionally add `--verbose` for verbose output.
# 
# Notes:
# 1. Optionally add `googletest/googlemock/src/gmock-all.cc` and/or
#    `googletest/googlemock/src/gmock_main.cc` too, if needed.
time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread \
    -I"googletest/googletest/include" -I"googletest/googletest" \
    -I"googletest/googlemock/include" -I"googletest/googlemock" \
    googletest/googletest/src/gtest-all.cc googletest/googletest/src/gtest_main.cc \
    gtest_demo__sample1_factorial_and_is_prime_unittest.cc \
    gtest_demo__sample1_factorial_and_is_prime.cc \
    -o bin/a && time bin/a
```

### More examples just to show building and running the samples which come with googletest

Using Option 1 from above (pre-building the `*.a` static library files for gtest and gmock):

1. `googletest/googletest/samples/sample1_unittest.cc`
    ```bash
    time ( \
        time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread \
        -I"googletest/googletest/include" -I"googletest/googlemock/include" \
        googletest/googletest/samples/sample1_unittest.cc \
        googletest/googletest/samples/sample1.cc \
        bin/libgtest.a bin/libgtest_main.a \
        -o bin/a \
        && time bin/a \
    )
    ```
1. `googletest/googletest/samples/sample2_unittest.cc`
    ```bash
    time ( \
        time g++ -Wall -Wextra -Werror -O3 -std=c++17 -pthread \
        -I"googletest/googletest/include" -I"googletest/googlemock/include" \
        googletest/googletest/samples/sample2_unittest.cc \
        googletest/googletest/samples/sample2.cc \
        bin/libgtest.a bin/libgtest_main.a \
        -o bin/a \
        && time bin/a \
    )
    ```

etc. 
